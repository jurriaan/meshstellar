CREATE TABLE "mesh_packets" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "gateway_id" text NOT NULL, "from_id" integer NOT NULL, "to_id" integer NOT NULL, "channel_id" integer NOT NULL, "unique_id" integer NOT NULL, "portnum" integer NOT NULL, "payload_data" blob NOT NULL, "rx_time" integer NOT NULL, "rx_snr" real NOT NULL, "rx_rssi" integer NOT NULL, "hop_start" integer DEFAULT 0 NOT NULL, "hop_limit" integer DEFAULT 0 NOT NULL, "want_ack" integer NOT NULL, "want_response" integer NOT NULL, "priority" integer NOT NULL, "source" integer, "dest" integer, "request_id" integer, "reply_id" integer, "emoji" integer, "created_at" integer NOT NULL, "hash" blob NOT NULL ) STRICT;
CREATE TABLE "node_info" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "mesh_packet_id" integer UNIQUE NOT NULL, "node_id" integer NOT NULL, "user_id" text NOT NULL, "long_name" text NOT NULL, "short_name" text NOT NULL, "hw_model_id" integer NOT NULL, "is_licensed" integer NOT NULL, "role" integer NOT NULL, FOREIGN KEY ("mesh_packet_id") REFERENCES "mesh_packets" ("id") ON DELETE CASCADE ) STRICT;
CREATE TABLE "positions" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "mesh_packet_id" integer UNIQUE NOT NULL, "node_id" integer NOT NULL, "latitude_i" integer NOT NULL, "longitude_i" integer NOT NULL, "latitude" real NOT NULL, "longitude" real NOT NULL, "altitude" integer NOT NULL, "time" integer NOT NULL, "location_source" integer NOT NULL, "altitude_source" integer NOT NULL, "timestamp" integer, "altitude_hae" integer NOT NULL, "altitude_geoidal_separation" integer NOT NULL, "pdop" integer NOT NULL, "hdop" integer NOT NULL, "vdop" integer NOT NULL, "gps_accuracy" integer NOT NULL, "ground_speed" integer NOT NULL, "ground_track" integer NOT NULL, "fix_quality" integer NOT NULL, "fix_type" integer NOT NULL, "sats_in_view" integer NOT NULL, "sensor_id" integer NOT NULL, "next_update" integer NOT NULL, "seq_number" integer NOT NULL, "precision_bits" integer NOT NULL, FOREIGN KEY ("mesh_packet_id") REFERENCES "mesh_packets" ("id") ON DELETE CASCADE ) STRICT;
CREATE TABLE "nodes" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "node_id" integer NOT NULL, "user_id" text NOT NULL, "last_rx_time" integer, "last_rx_snr" real, "last_rx_rssi" integer, "long_name" text, "short_name" text, "hw_model_id" integer, "is_licensed" integer, "role" integer, "latitude" real, "longitude" real, "altitude" integer, "last_node_info_id" integer, "last_position_id" integer, "battery_level" integer, "voltage" real, "channel_utilization" real, "air_util_tx" real, "last_device_metrics_id" integer NULL, "temperature" real, "relative_humidity" real, "barometric_pressure" real, "gas_resistance" real, "last_environment_metrics_id" integer NULL, "created_at" integer NOT NULL, FOREIGN KEY ("last_environment_metrics_id") REFERENCES "environment_metrics" ("id") ON DELETE SET NULL, FOREIGN KEY ("last_device_metrics_id") REFERENCES "device_metrics" ("id") ON DELETE SET NULL, FOREIGN KEY ("last_node_info_id") REFERENCES "node_info" ("id") ON DELETE CASCADE, FOREIGN KEY ("last_position_id") REFERENCES "positions" ("id") ON DELETE CASCADE ) STRICT;
CREATE TABLE "neighbors" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "mesh_packet_id" integer NOT NULL, "node_id" integer NOT NULL, "neighbor_node_id" integer NOT NULL, "snr" real NOT NULL, "timestamp" integer NOT NULL, FOREIGN KEY ("mesh_packet_id") REFERENCES "mesh_packets" ("id") ON DELETE CASCADE ) STRICT;
CREATE TABLE "device_metrics" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "mesh_packet_id" integer UNIQUE NOT NULL, "node_id" integer NOT NULL, "time" integer, "battery_level" integer NOT NULL, "voltage" real NOT NULL, "channel_utilization" real NOT NULL, "air_util_tx" real NOT NULL, FOREIGN KEY ("mesh_packet_id") REFERENCES "mesh_packets" ("id") ON DELETE CASCADE ) STRICT;
CREATE TABLE "environment_metrics" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "mesh_packet_id" integer UNIQUE NOT NULL, "node_id" integer NOT NULL, "time" integer, "temperature" real NOT NULL, "relative_humidity" real NOT NULL, "barometric_pressure" real NOT NULL, "gas_resistance" real NOT NULL, FOREIGN KEY ("mesh_packet_id") REFERENCES "mesh_packets" ("id") ON DELETE CASCADE ) STRICT;
CREATE TABLE "waypoints" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "mesh_packet_id" integer UNIQUE NOT NULL, "node_id" integer NOT NULL, "waypoint_id" integer NOT NULL, "latitude_i" integer NOT NULL, "longitude_i" integer NOT NULL, "latitude" real NOT NULL, "longitude" real NOT NULL, "expire" integer, "locked_to" integer, "name" text NOT NULL, "description" text NOT NULL, "icon" text NOT NULL, FOREIGN KEY ("mesh_packet_id") REFERENCES "mesh_packets" ("id") ON DELETE CASCADE ) STRICT;
CREATE TABLE "service_envelopes" ( "id" integer NOT NULL PRIMARY KEY AUTOINCREMENT, "payload_data" blob NOT NULL, "hash" blob NOT NULL, "created_at" integer NOT NULL, "processed_at" integer ) STRICT;
CREATE INDEX "idx_mesh_packets_from_id_to_id" ON "mesh_packets" ("from_id", "to_id");
CREATE INDEX "idx_mesh_packets_unique_id" ON "mesh_packets" ("unique_id");
CREATE INDEX "idx_mesh_packets_rx_time" ON "mesh_packets" ("rx_time");
CREATE INDEX "idx_mesh_packets_hash" ON "mesh_packets" ("hash");
CREATE UNIQUE INDEX "idx_nodes_unique_id" ON "nodes" ("node_id");
CREATE INDEX "idx_neighbors_timestamp" ON "neighbors" ("timestamp");
CREATE INDEX "idx_service_envelope_processed_at" ON "service_envelopes" ("processed_at");
