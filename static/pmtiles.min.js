"use strict";var pmtiles=(()=>{var e,n,s,o,a,c,d,h,m,f,p,g,v,b,j,y,w,x,C,E,k,A,M,F,T,z,D,N,R,P,H,I,B,V,$,W,U,K,q,Y,G,X,Q,J,O=Object.defineProperty,ue,je,Se,we,Oe,ae,ie,ne,ee,te,oe,re,ce,he,me,ye,ve,pe,De=Object.getOwnPropertyDescriptor,Ce=Object.getOwnPropertyNames,Ee=Object.prototype.hasOwnProperty,r=Math.pow,Te=(e,t)=>{for(var n in t)O(e,n,{get:t[n],enumerable:!0})},Le=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ce(t))!Ee.call(e,o)&&o!==n&&O(e,o,{get:()=>t[o],enumerable:!(s=De(t,o))||s.enumerable});return e},Re=e=>Le(O({},"__esModule",{value:!0}),e),t=(e,t,n)=>new Promise((s,o)=>{var a=e=>{try{i(n.next(e))}catch(e){o(e)}},r=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(a,r);i((n=n.apply(e,t)).next())}),se={};Te(se,{Compression:()=>M,EtagMismatch:()=>p,FetchSource:()=>T,FileSource:()=>pe,PMTiles:()=>j,Protocol:()=>W,ResolvedValueCache:()=>Q,SharedPromiseCache:()=>F,TileType:()=>C,bytesToHeader:()=>fe,findTile:()=>ge,getUint64:()=>i,leafletRasterLayer:()=>he,readVarint:()=>u,tileIdToZxy:()=>Ae,zxyToTileId:()=>_e}),n=Uint8Array,c=Uint16Array,ue=Int32Array,k=new n([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),E=new n([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),je=new n([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),x=function(e,t){for(var o,i,s=new c(31),n=0;n<31;++n)s[n]=t+=1<<e[n-1];for(i=new ue(s[30]),n=1;n<30;++n)for(o=s[n];o<s[n+1];++o)i[o]=o-s[n]<<5|n;return{b:s,r:i}},R=x(k,2),H=R.b,U=R.r,H[28]=258,U[258]=28,z=x(E,0),K=z.b,Se=z.r,g=new c(32768);for(e=0;e<32768;++e)a=(e&43690)>>1|(e&21845)<<1,a=(a&52428)>>2|(a&13107)<<2,a=(a&61680)>>4|(a&3855)<<4,g[e]=((a&65280)>>8|(a&255)<<8)>>1;m=function(e,t,n){for(var o,i,a,l,u,h,m,r=e.length,s=0,d=new c(t);s<r;++s)e[s]&&++d[e[s]-1];o=new c(t);for(s=1;s<t;++s)o[s]=o[s-1]+d[s-1]<<1;if(n){{i=new c(1<<t),u=15-t;for(s=0;s<r;++s)if(e[s])for(h=s<<4|e[s],l=t-e[s],a=o[e[s]-1]++<<l,m=a|(1<<l)-1;a<=m;++a)i[g[a]>>u]=h}}else{i=new c(r);for(s=0;s<r;++s)e[s]&&(i[s]=g[o[e[s]-1]++]>>15-e[s])}return i},h=new n(288);for(e=0;e<144;++e)h[e]=8;for(e=144;e<256;++e)h[e]=9;for(e=256;e<280;++e)h[e]=7;for(e=280;e<288;++e)h[e]=8;A=new n(32);for(e=0;e<32;++e)A[e]=5;we=m(h,9,1),Oe=m(A,5,1),v=function(e){for(var n=e[0],t=1;t<e.length;++t)e[t]>n&&(n=e[t]);return n},o=function(e,t,n){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(t&7)&n},y=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(t&7)},ae=function(e){return(e+7)/8|0},ie=function(e,t,s){(t==null||t<0)&&(t=0),(s==null||s>e.length)&&(s=e.length);var o=new n(s-t);return o.set(e.subarray(t,s)),o},$=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],s=function(e,t,n){var o=new Error(t||$[e]);if(o.code=e,Error.captureStackTrace&&Error.captureStackTrace(o,s),!n)throw o;return o},b=function(e,t,i,a){if(j=e.length,X=a?a.length:0,!j||t.f&&!t.l)return i||new n(0);N=!i||t.i!=2,C=t.i,i||(i=new n(j*3));var l,d,u,f,p,g,b,j,O,C,A,S,M,F,T,z,N,L,R,P,B,V,$,W,G,X,Q,Z,J,q=function(e){var t,s=i.length;e>s&&(t=new n(Math.max(s*2,e)),t.set(i),i=t)},x=t.f||0,r=t.p||0,c=t.b||0,h=t.l,D=t.d,_=t.m,w=t.n,ee,te,Y=j*8;do{if(!h){if(x=o(e,r,1),S=o(e,r+1,3),r+=3,!S){var u=ae(r)+4,I=e[u-4]|e[u-3]<<8,U=u+I;if(U>j){C&&s(0);break}N&&q(c+I),i.set(e.subarray(u,U),c),t.b=c+=I,t.p=r=U*8,t.f=x;continue}if(S==1)h=we,D=Oe,_=9,w=5;else if(S==2){L=o(e,r,31)+257,V=o(e,r+10,15)+4,P=L+o(e,r+5,31)+1,r+=14;for(g=new n(P),z=new n(19),l=0;l<V;++l)z[je[l]]=o(e,r+l*3,7);r+=V*3;for($=v(z),J=(1<<$)-1,ee=m(z,$,1),l=0;l<P;)if(W=ee[o(e,r,J)],r+=W&15,u=W>>4,u<16)g[l++]=u;else for(p=0,O=0,u==16?(O=3+o(e,r,3),r+=2,p=g[l-1]):u==17?(O=3+o(e,r,7),r+=3):u==18&&(O=11+o(e,r,127),r+=7);O--;)g[l++]=p;R=g.subarray(0,L),d=g.subarray(L),_=v(R),w=v(d),h=m(R,_,1),D=m(d,w,1)}else s(1);if(r>Y){C&&s(0);break}}for(N&&q(c+131072),Z=(1<<_)-1,Q=(1<<w)-1,A=r;;A=r){if(p=h[y(e,r)&Z],f=p>>4,r+=p&15,r>Y){C&&s(0);break}if(p||s(2),f<256)i[c++]=f;else if(f==256){A=r,h=null;break}else{if(G=f-254,f>264&&(l=f-257,b=k[l],G=o(e,r,(1<<b)-1)+H[l],r+=b),T=D[y(e,r)&Q],F=T>>4,T||s(3),r+=T&15,d=K[F],F>3&&(b=E[F],d+=y(e,r)&(1<<b)-1,r+=b),r>Y){C&&s(0);break}if(N&&q(c+131072),M=c+G,c<d)for(B=X-d,te=Math.min(d,M),B+c<0&&s(3);c<te;++c)i[c]=a[B+c];for(;c<M;c+=4)i[c]=i[c-d],i[c+1]=i[c+1-d],i[c+2]=i[c+2-d],i[c+3]=i[c+3-d];c=M}}t.l=h,t.p=A,t.b=c,t.f=x,h&&(x=1,t.m=_,t.d=D,t.n=w)}while(!x)return c==i.length?i:ie(i,0,c)},ne=new n(0),J=function(e){(e[0]!=31||e[1]!=139||e[2]!=8)&&s(6,"invalid gzip data");var o,t=e[3],n=10;t&4&&(n+=(e[10]|e[11]<<8)+2);for(o=(t>>3&1)+(t>>4&1);o>0;o-=!e[n++]);return n+(t&2)},X=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},q=function(e,t){return((e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&s(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&s(6,"invalid zlib data: "+(e[1]&32?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2};function Fe(e,t){return b(e,{i:2},t&&t.out,t&&t.dictionary)}function He(e,t){var o=J(e);return o+8>e.length&&s(6,"invalid gzip data"),b(e.subarray(o,-8),{i:2},t&&t.out||new n(X(e)),t&&t.dictionary)}function Pe(e,t){return b(e.subarray(q(e,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}function S(e,t){return e[0]==31&&e[1]==139&&e[2]==8?He(e,t):(e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31?Fe(e,t):Pe(e,t)}Y=typeof TextDecoder!="undefined"&&new TextDecoder,G=0;try{Y.decode(ne,{stream:!0}),G=1}catch{}V=(e,t)=>e*r(2,t),d=(e,t)=>Math.floor(e/r(2,t)),f=(e,t)=>V(e.getUint16(t+1,!0),8)+e.getUint8(t),B=(e,t)=>V(e.getUint32(t+2,!0),16)+e.getUint16(t,!0),ee=(e,t,n,s,o)=>{if(e!==s.getUint8(o))return e-s.getUint8(o);const i=f(s,o+1);if(t!==i)return t-i;const a=f(s,o+4);return n!==a?n-a:0},te=(e,t,n,s)=>{const o=P(e,t|128,n,s);return o?{z:t,x:n,y:s,offset:o[0],length:o[1],isDir:!0}:null},I=(e,t,n,s)=>{const o=P(e,t,n,s);return o?{z:t,x:n,y:s,offset:o[0],length:o[1],isDir:!1}:null},P=(e,t,n,s)=>{let o=0,i=e.byteLength/17-1;for(;o<=i;){const a=i+o>>1,r=ee(t,n,s,e,a*17);if(r>0)o=a+1;else if(r<0)i=a-1;else return[B(e,a*17+7),e.getUint32(a*17+13,!0)]}return null},oe=(e,t)=>e.isDir&&!t.isDir?1:!e.isDir&&t.isDir?-1:e.z!==t.z?e.z-t.z:e.x!==t.x?e.x-t.x:e.y-t.y,N=(e,t)=>{const n=e.getUint8(t*17),s=n&127;return{z:s,x:f(e,t*17+1),y:f(e,t*17+4),offset:B(e,t*17+7),length:e.getUint32(t*17+13,!0),isDir:n>>7===1}},D=e=>{const t=[],n=new DataView(e);for(let e=0;e<n.byteLength/17;e++)t.push(N(n,e));return re(t)},re=e=>{e.sort(oe);const n=new ArrayBuffer(17*e.length),t=new Uint8Array(n);for(let n=0;n<e.length;n++){const s=e[n];let o=s.z;s.isDir&&(o=o|128),t[n*17]=o,t[n*17+1]=s.x&255,t[n*17+2]=s.x>>8&255,t[n*17+3]=s.x>>16&255,t[n*17+4]=s.y&255,t[n*17+5]=s.y>>8&255,t[n*17+6]=s.y>>16&255,t[n*17+7]=s.offset&255,t[n*17+8]=d(s.offset,8)&255,t[n*17+9]=d(s.offset,16)&255,t[n*17+10]=d(s.offset,24)&255,t[n*17+11]=d(s.offset,32)&255,t[n*17+12]=d(s.offset,48)&255,t[n*17+13]=s.length&255,t[n*17+14]=s.length>>8&255,t[n*17+15]=s.length>>16&255,t[n*17+16]=s.length>>24&255}return n},ce=(e,t)=>{if(e.byteLength<17)return null;const s=e.byteLength/17,n=N(e,s-1);if(n.isDir){const e=n.z,s=t.z-e,o=Math.trunc(t.x/(1<<s)),i=Math.trunc(t.y/(1<<s));return{z:e,x:o,y:i}}return null};function Ne(e){return t(this,null,function*(){const o=yield e.getBytes(0,512e3),n=new DataView(o.data),s=n.getUint32(4,!0),g=n.getUint16(8,!0),p=new TextDecoder("utf-8"),t=JSON.parse(p.decode(new DataView(o.data,10,s)));let a=0;t.compression==="gzip"&&(a=2);let r=0;"minzoom"in t&&(r=+t.minzoom);let c=0;"maxzoom"in t&&(c=+t.maxzoom);let l=0,d=0,u=0,i=-180,h=-85,m=180,f=85;if(t.bounds){const e=t.bounds.split(",");i=+e[0],h=+e[1],m=+e[2],f=+e[3]}if(t.center){const e=t.center.split(",");l=+e[0],d=+e[1],u=+e[2]}const v={specVersion:n.getUint16(2,!0),rootDirectoryOffset:10+s,rootDirectoryLength:g*17,jsonMetadataOffset:10,jsonMetadataLength:s,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:a,tileType:1,minZoom:r,maxZoom:c,minLon:i,minLat:h,maxLon:m,maxLat:f,centerZoom:u,centerLon:l,centerLat:d,etag:o.etag};return v})}function xe(e,n,s,o,i,a,r){return t(this,null,function*(){let t=yield s.getArrayBuffer(n,e.rootDirectoryOffset,e.rootDirectoryLength,e);e.specVersion===1&&(t=D(t));const l=I(new DataView(t),o,i,a);if(l){const s=yield n.getBytes(l.offset,l.length,r);let e=s.data;const t=new DataView(e);return t.getUint8(0)===31&&t.getUint8(1)===139&&(e=S(new Uint8Array(e))),{data:e}}const c=ce(new DataView(t),{z:o,x:i,y:a});if(c){const l=te(new DataView(t),c.z,c.x,c.y);if(l){let t=yield s.getArrayBuffer(n,l.offset,l.length,e);e.specVersion===1&&(t=D(t));const c=I(new DataView(t),o,i,a);if(c){const s=yield n.getBytes(c.offset,c.length,r);let e=s.data;const t=new DataView(e);return t.getUint8(0)===31&&t.getUint8(1)===139&&(e=S(new Uint8Array(e))),{data:e}}}}})}w={getHeader:Ne,getZxy:xe},he=(e,t)=>{let s=!1,n="";const o=L.GridLayer.extend({createTile:(t,o)=>{const i=document.createElement("img"),a=new AbortController,r=a.signal;return i.cancel=()=>{a.abort()},s||(e.getHeader().then(e=>{e.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):e.tileType===2?n="image/png":e.tileType===3?n="image/jpeg":e.tileType===4?n="image/webp":e.tileType===5&&(n="image/avif")}),s=!0),e.getZxy(t.z,t.x,t.y,r).then(e=>{if(e){const t=new Blob([e.data],{type:n}),s=window.URL.createObjectURL(t);i.src=s,i.cancel=void 0,o(void 0,i)}}).catch(e=>{if(e.name!=="AbortError")throw e}),i},_removeTile:function(e){const t=this._tiles[e];if(!t)return;t.el.cancel&&t.el.cancel(),t.el.width=0,t.el.height=0,t.el.deleted=!0,L.DomUtil.remove(t.el),delete this._tiles[e],this.fire("tileunload",{tile:t.el,coords:this._keyToTileCoords(e)})}});return new o(t)},me=e=>(t,n)=>{if(n instanceof AbortController)return e(t,n);const s=new AbortController;return e(t,s).then(e=>n(void 0,e.data,e.cacheControl||"",e.expires||""),e=>n(e)).catch(e=>n(e)),{cancel:()=>s.abort()}},W=class{constructor(){this.tilev4=(e,n)=>t(this,null,function*(){if(e.type==="json"){const s=e.url.substr(10);let n=this.tiles.get(s);n||(n=new j(s),this.tiles.set(s,n));const t=yield n.getHeader();return{data:{tiles:[`${e.url}/{z}/{x}/{y}`],minzoom:t.minZoom,maxzoom:t.maxZoom,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat]}}}const a=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=e.url.match(a);if(!s)throw new Error("Invalid PMTiles protocol URL");const i=s[1];let t=this.tiles.get(i);t||(t=new j(i),this.tiles.set(i,t));const r=s[2],c=s[3],l=s[4],d=yield t.getHeader(),o=yield t?.getZxy(+r,+c,+l,n.signal);return o?{data:new Uint8Array(o.data),cacheControl:o.cacheControl,expires:o.expires}:d.tileType===1?{data:new Uint8Array}:{data:null}}),this.tile=me(this.tilev4),this.tiles=new Map}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};function l(e,t){return(t>>>0)*4294967296+(e>>>0)}function ke(e,t){const o=t.buf;let n=o[t.pos++],s=(n&112)>>4;if(n<128)return l(e,s);if(n=o[t.pos++],s|=(n&127)<<3,n<128)return l(e,s);if(n=o[t.pos++],s|=(n&127)<<10,n<128)return l(e,s);if(n=o[t.pos++],s|=(n&127)<<17,n<128)return l(e,s);if(n=o[t.pos++],s|=(n&127)<<24,n<128)return l(e,s);if(n=o[t.pos++],s|=(n&1)<<31,n<128)return l(e,s);throw new Error("Expected varint not more than 10 bytes")}function u(e){const s=e.buf;let t=s[e.pos++],n=t&127;return t<128?n:(t=s[e.pos++],n|=(t&127)<<7,t<128?n:(t=s[e.pos++],n|=(t&127)<<14,t<128?n:(t=s[e.pos++],n|=(t&127)<<21,t<128?n:(t=s[e.pos],n|=(t&15)<<28,ke(n,e)))))}function be(e,t,n,s){if(s===0){n===1&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);const s=t[0];t[0]=t[1],t[1]=s}}function Me(e,t){const c=r(2,e);let o=t,a=t,i=t;const n=[0,0];let s=1;for(;s<c;)o=1&i/2,a=1&(i^o),be(s,n,o,a),n[0]+=s*o,n[1]+=s*a,i=i/4,s*=2;return[e,n[0],n[1]]}ye=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,1501199875790165];function _e(e,t,n){if(e>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(t>r(2,e)-1||n>r(2,e)-1)throw Error("tile x/y outside zoom level bounds");const l=ye[e],d=r(2,e);let o=0,i=0,c=0;const a=[t,n];let s=d/2;for(;s>0;)o=(a[0]&s)>0?1:0,i=(a[1]&s)>0?1:0,c+=s*s*(3*o^i),be(s,a,o,i),s=s/2;return l+c}function Ae(e){let t=0;const n=0;for(let n=0;n<27;n++){const s=(1<<n)*(1<<n);if(t+s>e)return Me(n,e-t);t+=s}throw Error("Tile zoom level exceeds max safe number limit (26)")}M=(e=>(e[e.Unknown=0]="Unknown",e[e.None=1]="None",e[e.Gzip=2]="Gzip",e[e.Brotli=3]="Brotli",e[e.Zstd=4]="Zstd",e))(M||{});function _(e,n){return t(this,null,function*(){if(n===1||n===0)return e;if(n===2){if(typeof globalThis.DecompressionStream=="undefined")return S(new Uint8Array(e));const t=new Response(e).body;if(!t)throw Error("Failed to read response stream");const n=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(n).arrayBuffer()}throw Error("Compression method not supported")})}C=(e=>(e[e.Unknown=0]="Unknown",e[e.Mvt=1]="Mvt",e[e.Png=2]="Png",e[e.Jpeg=3]="Jpeg",e[e.Webp=4]="Webp",e[e.Avif=5]="Avif",e))(C||{}),ve=127;function ge(e,t){let s=0,n=e.length-1;for(;s<=n;){const o=n+s>>1,i=t-e[o].tileId;if(i>0)s=o+1;else if(i<0)n=o-1;else return e[o]}if(n>=0){if(e[n].runLength===0)return e[n];if(t-e[n].tileId<e[n].runLength)return e[n]}return null}pe=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,n){return t(this,null,function*(){const t=this.file.slice(e,e+n),s=yield t.arrayBuffer();return{data:s}})}},T=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,n,s,o){return t(this,null,function*(){let a,r;s?r=s:(a=new AbortController,r=a.signal);const c=new Headers(this.customHeaders);c.set("range",`bytes=${e}-${e+n-1}`);let l;this.mustReload&&(l="reload");let t=yield fetch(this.url,{signal:r,cache:l,headers:c});if(e===0&&t.status===416){const e=t.headers.get("Content-Range");if(!e||!e.startsWith("bytes */"))throw Error("Missing content-length on 416 response");const n=+e.substr(8);t=yield fetch(this.url,{signal:r,cache:"reload",headers:{range:`bytes=0-${n-1}`}})}let i=t.headers.get("Etag");if(i?.startsWith("W/")&&(i=null),t.status===416||o&&i&&i!==o)throw this.mustReload=!0,new p(o);if(t.status>=300)throw Error(`Bad response code: ${t.status}`);const d=t.headers.get("Content-Length");if(t.status===200&&(!d||+d>n))throw a&&a.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");const u=yield t.arrayBuffer();return{data:u,etag:i||void 0,cacheControl:t.headers.get("Cache-Control")||void 0,expires:t.headers.get("Expires")||void 0}})}};function i(e,t){const n=e.getUint32(t+4,!0),s=e.getUint32(t+0,!0);return n*r(2,32)+s}function fe(e,t){const n=new DataView(e),s=n.getUint8(7);if(s>3)throw Error(`Archive is spec version ${s} but this library supports up to spec version 3`);return{specVersion:s,rootDirectoryOffset:i(n,8),rootDirectoryLength:i(n,16),jsonMetadataOffset:i(n,24),jsonMetadataLength:i(n,32),leafDirectoryOffset:i(n,40),leafDirectoryLength:i(n,48),tileDataOffset:i(n,56),tileDataLength:i(n,64),numAddressedTiles:i(n,72),numTileEntries:i(n,80),numTileContents:i(n,88),clustered:n.getUint8(96)===1,internalCompression:n.getUint8(97),tileCompression:n.getUint8(98),tileType:n.getUint8(99),minZoom:n.getUint8(100),maxZoom:n.getUint8(101),minLon:n.getInt32(102,!0)/1e7,minLat:n.getInt32(106,!0)/1e7,maxLon:n.getInt32(110,!0)/1e7,maxLat:n.getInt32(114,!0)/1e7,centerZoom:n.getUint8(118),centerLon:n.getInt32(119,!0)/1e7,centerLat:n.getInt32(123,!0)/1e7,etag:t}}function de(e){const n={buf:new Uint8Array(e),pos:0},s=u(n),t=[];let o=0;for(let e=0;e<s;e++){const i=u(n);t.push({tileId:o+i,offset:0,length:0,runLength:1}),o+=i}for(let e=0;e<s;e++)t[e].runLength=u(n);for(let e=0;e<s;e++)t[e].length=u(n);for(let e=0;e<s;e++){const o=u(n);o===0&&e>0?t[e].offset=t[e-1].offset+t[e-1].length:t[e].offset=o-1}return t}function ze(e){const t=new DataView(e);return t.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):t.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}p=class extends Error{};function le(e,n){return t(this,null,function*(){const s=yield e.getBytes(0,16384),i=new DataView(s.data);if(i.getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(ze(s.data)<3)return[yield w.getHeader(e)];const a=s.data.slice(0,ve),t=fe(a,s.etag),r=s.data.slice(t.rootDirectoryOffset,t.rootDirectoryOffset+t.rootDirectoryLength),c=`${e.getKey()}|${t.etag||""}|${t.rootDirectoryOffset}|${t.rootDirectoryLength}`,o=de(yield n(r,t.internalCompression));return[t,[c,o.length,o]]})}function Z(e,n,s,o,i){return t(this,null,function*(){const a=yield e.getBytes(s,o,void 0,i.etag),r=yield n(a.data,i.internalCompression),t=de(r);if(t.length===0)throw new Error("Empty directory is invalid");return t})}return Q=class{constructor(e=100,t=!0,n=_){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=n}getHeader(e){return t(this,null,function*(){const s=e.getKey(),n=this.cache.get(s);if(n){n.lastUsed=this.counter++;const e=n.data;return e}const t=yield le(e,this.decompress);return t[1]&&this.cache.set(t[1][0],{lastUsed:this.counter++,data:t[1][2]}),this.cache.set(s,{lastUsed:this.counter++,data:t[0]}),this.prune(),t[0]})}getDirectory(e,n,s,o){return t(this,null,function*(){const i=`${e.getKey()}|${o.etag||""}|${n}|${s}`,t=this.cache.get(i);if(t){t.lastUsed=this.counter++;const e=t.data;return e}const a=yield Z(e,this.decompress,n,s,o);return this.cache.set(i,{lastUsed:this.counter++,data:a}),this.prune(),a})}getArrayBuffer(e,n,s,o){return t(this,null,function*(){const i=`${e.getKey()}|${o.etag||""}|${n}|${s}`,t=this.cache.get(i);if(t){t.lastUsed=this.counter++;const e=yield t.data;return e}const a=yield e.getBytes(n,s,void 0,o.etag);return this.cache.set(i,{lastUsed:this.counter++,data:a.data}),this.prune(),a.data})}prune(){if(this.cache.size>this.maxCacheEntries){let t=1/0,e=void 0;this.cache.forEach((n,s)=>{n.lastUsed<t&&(t=n.lastUsed,e=s)}),e&&this.cache.delete(e)}}invalidate(e){return t(this,null,function*(){this.cache.delete(e.getKey())})}},F=class{constructor(e=100,t=!0,n=_){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=n}getHeader(e){return t(this,null,function*(){const n=e.getKey(),t=this.cache.get(n);if(t){t.lastUsed=this.counter++;const e=yield t.data;return e}const s=new Promise((t,n)=>{le(e,this.decompress).then(e=>{e[1]&&this.cache.set(e[1][0],{lastUsed:this.counter++,data:Promise.resolve(e[1][2])}),t(e[0]),this.prune()}).catch(e=>{n(e)})});return this.cache.set(n,{lastUsed:this.counter++,data:s}),s})}getDirectory(e,n,s,o){return t(this,null,function*(){const i=`${e.getKey()}|${o.etag||""}|${n}|${s}`,t=this.cache.get(i);if(t){t.lastUsed=this.counter++;const e=yield t.data;return e}const a=new Promise((t,i)=>{Z(e,this.decompress,n,s,o).then(e=>{t(e),this.prune()}).catch(e=>{i(e)})});return this.cache.set(i,{lastUsed:this.counter++,data:a}),a})}getArrayBuffer(e,n,s,o){return t(this,null,function*(){const t=`${e.getKey()}|${o.etag||""}|${n}|${s}`,i=this.cache.get(t);if(i){i.lastUsed=this.counter++;const e=yield i.data;return e}const a=new Promise((i,a)=>{e.getBytes(n,s,void 0,o.etag).then(e=>{i(e.data),this.cache.has(t),this.prune()}).catch(e=>{a(e)})});return this.cache.set(t,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let t=1/0,e=void 0;this.cache.forEach((n,s)=>{n.lastUsed<t&&(t=n.lastUsed,e=s)}),e&&this.cache.delete(e)}}invalidate(e){return t(this,null,function*(){const t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());const n=new Promise((n,s)=>{this.getHeader(e).then(e=>{n(),this.invalidations.delete(t)}).catch(e=>{s(e)})});this.invalidations.set(t,n)})}},j=class{constructor(e,t,n){typeof e=="string"?this.source=new T(e):this.source=e,n?this.decompress=n:this.decompress=_,t?this.cache=t:this.cache=new F}getHeader(){return t(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,n,s,o){return t(this,null,function*(){const r=_e(e,n,s),t=yield this.cache.getHeader(this.source);if(t.specVersion<3)return w.getZxy(t,this.source,this.cache,e,n,s,o);if(e<t.minZoom||e>t.maxZoom)return void 0;let i=t.rootDirectoryOffset,a=t.rootDirectoryLength;for(let n=0;n<=3;n++){const s=yield this.cache.getDirectory(this.source,i,a,t),e=ge(s,r);if(e){if(e.runLength>0){const n=yield this.source.getBytes(t.tileDataOffset+e.offset,e.length,o,t.etag);return{data:yield this.decompress(n.data,t.tileCompression),cacheControl:n.cacheControl,expires:n.expires}}i=t.leafDirectoryOffset+e.offset,a=e.length}else return void 0}throw Error("Maximum directory depth exceeded")})}getZxy(e,n,s,o){return t(this,null,function*(){try{return yield this.getZxyAttempt(e,n,s,o)}catch(t){if(t instanceof p)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,n,s,o);throw t}})}getMetadataAttempt(){return t(this,null,function*(){const e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),n=yield this.decompress(t.data,e.internalCompression),s=new TextDecoder("utf-8");return JSON.parse(s.decode(n))})}getMetadata(){return t(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof p)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}},Re(se)})()