"use strict";var pmtiles=(()=>{f=Object.defineProperty,de=Object.getOwnPropertyDescriptor,se=Object.getOwnPropertyNames,W=Object.prototype.hasOwnProperty,l=Math.pow,e=(e,t)=>f(e,"name",{value:t,configurable:!0}),K=(e,t)=>{for(var n in t)f(e,n,{get:t[n],enumerable:!0})},Q=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of se(t))!W.call(e,o)&&o!==n&&f(e,o,{get:()=>t[o],enumerable:!(s=de(t,o))||s.enumerable});return e},oe=e=>Q(f({},"__esModule",{value:!0}),e),n=(e,t,n)=>new Promise((s,o)=>{var a=e=>{try{i(n.next(e))}catch(e){o(e)}},r=e=>{try{i(n.throw(e))}catch(e){o(e)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(a,r);i((n=n.apply(e,t)).next())}),A={},K(A,{Compression:()=>k,EtagMismatch:()=>m,FetchSource:()=>P,FileSource:()=>Z,PMTiles:()=>p,Protocol:()=>te,ResolvedValueCache:()=>re,SharedPromiseCache:()=>w,TileType:()=>E,bytesToHeader:()=>b,findTile:()=>y,getUint64:()=>s,leafletRasterLayer:()=>be,readVarint:()=>c,tileIdToZxy:()=>ce,tileTypeExt:()=>_,zxyToTileId:()=>M});var f,de,se,e,t,r,l,d,h,S,G,X,te,ae,E,k,me,m,v,j,W,K,Q,oe,n,A,F,re,p,w,O,C,P,B,Z,i=Uint8Array,u=Uint16Array,Ae=Int32Array,le=new i([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),$=new i([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Me=new i([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),fe=e(function(e,t){for(var o,i,s=new u(31),n=0;n<31;++n)s[n]=t+=1<<e[n-1];for(i=new Ae(s[30]),n=1;n<30;++n)for(o=s[n];o<s[n+1];++o)i[o]=o-s[n]<<5|n;return{b:s,r:i}},"freb"),ee=fe(le,2),pe=ee.b,ge=ee.r;pe[28]=258,ge[258]=28;var he=fe($,0),Se=he.b,Fe=he.r,x=new u(32768);for(t=0;t<32768;++t)r=(t&43690)>>1|(t&21845)<<1,r=(r&52428)>>2|(r&13107)<<2,r=(r&61680)>>4|(r&3855)<<4,x[t]=((r&65280)>>8|(r&255)<<8)>>1;h=e(function(e,t,n){for(var a=e.length,s=0,c=new u(t);s<a;++s)e[s]&&++c[e[s]-1];o=new u(t);for(s=1;s<t;++s)o[s]=o[s-1]+c[s-1]<<1;if(n){{i=new u(1<<t),l=15-t;for(s=0;s<a;++s)if(e[s])for(var o,i,l,h=s<<4|e[s],d=t-e[s],r=o[e[s]-1]++<<d,m=r|(1<<d)-1;r<=m;++r)i[x[r]>>l]=h}}else for(i=new u(a),s=0;s<a;++s)e[s]&&(i[s]=x[o[e[s]-1]++]>>15-e[s]);return i},"hMap"),d=new i(288);for(t=0;t<144;++t)d[t]=8;for(t=144;t<256;++t)d[t]=9;for(t=256;t<280;++t)d[t]=7;for(t=280;t<288;++t)d[t]=8;S=new i(32);for(t=0;t<32;++t)S[t]=5;var ke=h(d,9,1),Ee=h(S,5,1),T=e(function(e){for(var n=e[0],t=1;t<e.length;++t)e[t]>n&&(n=e[t]);return n},"max"),a=e(function(e,t,n){var s=t/8|0;return(e[s]|e[s+1]<<8)>>(t&7)&n},"bits"),D=e(function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(t&7)},"bits16"),Ce=e(function(e){return(e+7)/8|0},"shft"),xe=e(function(e,t,n){return(t==null||t<0)&&(t=0),(n==null||n>e.length)&&(n=e.length),new i(e.subarray(t,n))},"slc"),ve=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],o=e(function(e,t,n){var s=new Error(t||ve[e]);if(s.code=e,Error.captureStackTrace&&Error.captureStackTrace(s,o),!n)throw s;return s},"err"),I=e(function(t,n,s,r){if(_=t.length,q=r?r.length:0,!_||n.f&&!n.l)return s||new i(0);var U=!s,I=U||n.i!=2,A=n.i;U&&(s=new i(_*3));var d,u,m,p,g,v,j,_,C,E,k,F,z,N,H,W,q,X,R=e(function(e){var t,n=s.length;e>n&&(t=new i(Math.max(n*2,e)),t.set(s),s=t)},"cbuf"),b=n.f||0,c=n.p||0,l=n.b||0,f=n.l,x=n.d,w=n.m,O=n.n,L=_*8;do{if(!f){if(b=a(t,c,1),C=a(t,c+1,3),c+=3,C)if(C==1)f=ke,x=Ee,w=9,O=5;else if(C==2){var V=a(t,c,31)+257,K=a(t,c+10,15)+4,G=V+a(t,c+5,31)+1;c+=14;for(var y=new i(G),P=new i(19),d=0;d<K;++d)P[Me[d]]=a(t,c+d*3,7);c+=K*3;for(var Y=T(P),ee=(1<<Y)-1,J=h(P,Y,1),d=0;d<G;)if(N=J[a(t,c,ee)],c+=N&15,u=N>>4,u<16)y[d++]=u;else{p=0,j=0;for(u==16?(j=3+a(t,c,3),c+=2,p=y[d-1]):u==17?(j=3+a(t,c,7),c+=3):u==18&&(j=11+a(t,c,127),c+=7);j--;)y[d++]=p}H=y.subarray(0,V),m=y.subarray(V),w=T(H),O=T(m),f=h(H,w,1),x=h(m,O,1)}else o(1);else{var u=Ce(c)+4,B=t[u-4]|t[u-3]<<8,M=u+B;if(M>_){A&&o(0);break}I&&R(l+B),s.set(t.subarray(u,M),l),n.b=l+=B,n.p=c=M*8,n.f=b;continue}if(c>L){A&&o(0);break}}I&&R(l+131072);for(var Z=(1<<w)-1,Q=(1<<O)-1,S=c;;S=c){if(p=f[D(t,c)&Z],g=p>>4,c+=p&15,c>L){A&&o(0);break}if(p||o(2),g<256)s[l++]=g;else if(g==256){S=c,f=null;break}else{if(W=g-254,g>264&&(d=g-257,v=le[d],W=a(t,c,(1<<v)-1)+pe[d],c+=v),k=x[D(t,c)&Q],E=k>>4,k||o(3),c+=k&15,m=Se[E],E>3&&(v=$[E],m+=D(t,c)&(1<<v)-1,c+=v),c>L){A&&o(0);break}if(I&&R(l+131072),z=l+W,l<m){F=q-m,X=Math.min(m,z);for(F+l<0&&o(3);l<X;++l)s[l]=r[F+l]}for(;l<z;++l)s[l]=s[l-m]}}n.l=f,n.p=S,n.b=l,n.f=b,f&&(b=1,n.m=w,n.d=x,n.n=O)}while(!b)return l!=s.length&&U?xe(s,0,l):s.subarray(0,l)},"inflt"),we=new i(0),_e=e(function(e){(e[0]!=31||e[1]!=139||e[2]!=8)&&o(6,"invalid gzip data");var s,t=e[3],n=10;t&4&&(n+=(e[10]|e[11]<<8)+2);for(s=(t>>3&1)+(t>>4&1);s>0;s-=!e[n++]);return n+(t&2)},"gzs"),ye=e(function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},"gzl"),je=e(function(e,t){return((e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&o(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&o(6,"invalid zlib data: "+(e[1]&32?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2},"zls");function U(e,t){return I(e,{i:2},t&&t.out,t&&t.dictionary)}e(U,"inflateSync");function ne(e,t){var n=_e(e);return n+8>e.length&&o(6,"invalid gzip data"),I(e.subarray(n,-8),{i:2},t&&t.out||new i(ye(e)),t&&t.dictionary)}e(ne,"gunzipSync");function q(e,t){return I(e.subarray(je(e,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}e(q,"unzlibSync");function Y(e,t){return e[0]==31&&e[1]==139&&e[2]==8?ne(e,t):(e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31?U(e,t):q(e,t)}e(Y,"decompressSync"),G=typeof TextDecoder!="undefined"&&new TextDecoder,X=0;try{G.decode(we,{stream:!0}),X=1}catch{}var be=e((t,n)=>{let o=!1,s="",i=L.GridLayer.extend({createTile:e((e,n)=>{let i=document.createElement("img"),a=new AbortController,r=a.signal;return i.cancel=()=>{a.abort()},o||(t.getHeader().then(e=>{e.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):e.tileType===2?s="image/png":e.tileType===3?s="image/jpeg":e.tileType===4?s="image/webp":e.tileType===5&&(s="image/avif")}),o=!0),t.getZxy(e.z,e.x,e.y,r).then(e=>{if(e){let t=new Blob([e.data],{type:s}),o=window.URL.createObjectURL(t);i.src=o,i.cancel=0[0],n(0[0],i)}}).catch(e=>{if(e.name!=="AbortError")throw e}),i},"createTile"),_removeTile:e(function(e){let t=this._tiles[e];t&&(t.el.cancel&&t.el.cancel(),t.el.width=0,t.el.height=0,t.el.deleted=!0,L.DomUtil.remove(t.el),delete this._tiles[e],this.fire("tileunload",{tile:t.el,coords:this._keyToTileCoords(e)}))},"_removeTile")});return new i(n)},"leafletRasterLayer"),Oe=e(t=>(n,s)=>{if(s instanceof AbortController)return t(n,s);let o=new AbortController;return t(n,o).then(e=>s(0[0],e.data,e.cacheControl||"",e.expires||""),e=>s(e)).catch(e=>s(e)),{cancel:e(()=>o.abort(),"cancel")}},"v3compat"),J=class ae{constructor(t){this.tilev4=e((e,t)=>n(this,null,function*(){if(e.type==="json"){let s=e.url.substr(10),n=this.tiles.get(s);if(n||(n=new p(s),this.tiles.set(s,n)),this.metadata)return{data:yield n.getTileJson(e.url)};let t=yield n.getHeader();return(t.minLon>=t.maxLon||t.minLat>=t.maxLat)&&console.error(`Bounds of PMTiles archive ${t.minLon},${t.minLat},${t.maxLon},${t.maxLat} are not valid.`),{data:{tiles:[`${e.url}/{z}/{x}/{y}`],minzoom:t.minZoom,maxzoom:t.maxZoom,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat]}}}let a=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),s=e.url.match(a);if(!s)throw new Error("Invalid PMTiles protocol URL");let i=s[1],n=this.tiles.get(i);n||(n=new p(i),this.tiles.set(i,n));let r=s[2],c=s[3],l=s[4],d=yield n.getHeader(),o=yield n?.getZxy(+r,+c,+l,t.signal);if(o)return{data:new Uint8Array(o.data),cacheControl:o.cacheControl,expires:o.expires};if(d.tileType===1){if(this.errorOnMissingTile)throw new Error("Tile not found.");return{data:new Uint8Array}}return{data:null}}),"tilev4"),this.tile=Oe(this.tilev4),this.tiles=new Map,this.metadata=t?.metadata||!1,this.errorOnMissingTile=t?.errorOnMissingTile||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};e(J,"Protocol"),te=J;function ue(e,t){return(t>>>0)*4294967296+(e>>>0)}e(ue,"toNum");function V(e,t){let s=t.buf,n=s[t.pos++],o=(n&112)>>4;if(n<128||(n=s[t.pos++],o|=(n&127)<<3,n<128)||(n=s[t.pos++],o|=(n&127)<<10,n<128)||(n=s[t.pos++],o|=(n&127)<<17,n<128)||(n=s[t.pos++],o|=(n&127)<<24,n<128)||(n=s[t.pos++],o|=(n&1)<<31,n<128))return ue(e,o);throw new Error("Expected varint not more than 10 bytes")}e(V,"readVarintRemainder");function c(e){let s=e.buf,t=s[e.pos++],n=t&127;return t<128||(t=s[e.pos++],n|=(t&127)<<7,t<128)||(t=s[e.pos++],n|=(t&127)<<14,t<128)||(t=s[e.pos++],n|=(t&127)<<21,t<128)?n:(t=s[e.pos],n|=(t&15)<<28,V(n,e))}e(c,"readVarint");function z(e,t,n,s){if(s===0){n===1&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);let s=t[0];t[0]=t[1],t[1]=s}}e(z,"rotate");function ie(e,t){let r=l(2,e),o=t,a=t,i=t,n=[0,0],s=1;for(;s<r;)o=1&i/2,a=1&(i^o),z(s,n,o,a),n[0]+=s*o,n[1]+=s*a,i=i/4,s*=2;return[e,n[0],n[1]]}e(ie,"idOnLevel"),ae=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function M(e,t,n){if(e>26)throw new Error("Tile zoom level exceeds max safe number limit (26)");if(t>l(2,e)-1||n>l(2,e)-1)throw new Error("tile x/y outside zoom level bounds");let c=ae[e],d=l(2,e),o=0,i=0,r=0,a=[t,n],s=d/2;for(;s>0;)o=(a[0]&s)>0?1:0,i=(a[1]&s)>0?1:0,r+=s*s*(3*o^i),z(s,a,o,i),s=s/2;return c+r}e(M,"zxyToTileId");function ce(e){let t=0,n=0;for(let n=0;n<27;n++){let s=(1<<n)*(1<<n);if(t+s>e)return ie(n,e-t);t+=s}throw new Error("Tile zoom level exceeds max safe number limit (26)")}e(ce,"tileIdToZxy"),k=(e=>(e[e.Unknown=0]="Unknown",e[e.None=1]="None",e[e.Gzip=2]="Gzip",e[e.Brotli=3]="Brotli",e[e.Zstd=4]="Zstd",e))(k||{});function g(e,t){return n(this,null,function*(){if(t===1||t===0)return e;if(t===2){if(typeof globalThis.DecompressionStream=="undefined")return Y(new Uint8Array(e));let t=new Response(e).body;if(!t)throw new Error("Failed to read response stream");let n=t.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(n).arrayBuffer()}throw new Error("Compression method not supported")})}e(g,"defaultDecompress"),E=(e=>(e[e.Unknown=0]="Unknown",e[e.Mvt=1]="Mvt",e[e.Png=2]="Png",e[e.Jpeg=3]="Jpeg",e[e.Webp=4]="Webp",e[e.Avif=5]="Avif",e))(E||{});function _(e){return e===1?".mvt":e===2?".png":e===3?".jpg":e===4?".webp":e===5?".avif":""}e(_,"tileTypeExt"),me=127;function y(e,t){let s=0,n=e.length-1;for(;s<=n;){let o=n+s>>1,i=t-e[o].tileId;if(i>0)s=o+1;else if(i<0)n=o-1;else return e[o]}return n>=0&&(e[n].runLength===0||t-e[n].tileId<e[n].runLength)?e[n]:null}e(y,"findTile"),j=class le{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return n(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}},e(j,"FileSource"),Z=j,v=class he{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let n="";"navigator"in globalThis&&(n=globalThis.navigator.userAgent||"");let s=n.indexOf("Windows")>-1,o=/Chrome|Chromium|Edg|OPR|Brave/.test(n);this.chromeWindowsNoCache=!1,s&&o&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,s,o){return n(this,null,function*(){let a,r;s?r=s:(a=new AbortController,r=a.signal);let l=new Headers(this.customHeaders);l.set("range",`bytes=${e}-${e+t-1}`);let c;this.mustReload?c="reload":this.chromeWindowsNoCache&&(c="no-store");let n=yield fetch(this.url,{signal:r,cache:c,headers:l});if(e===0&&n.status===416){let e=n.headers.get("Content-Range");if(!e||!e.startsWith("bytes */"))throw new Error("Missing content-length on 416 response");let t=+e.substr(8);n=yield fetch(this.url,{signal:r,cache:"reload",headers:{range:`bytes=0-${t-1}`}})}let i=n.headers.get("Etag");if(i!=null&&i.startsWith("W/")&&(i=null),n.status===416||o&&i&&i!==o)throw this.mustReload=!0,new m(`Server returned non-matching ETag ${o} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(n.status>=300)throw new Error(`Bad response code: ${n.status}`);let d=n.headers.get("Content-Length");if(n.status===200&&(!d||+d>t))throw a&&a.abort(),new Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield n.arrayBuffer(),etag:i||0[0],cacheControl:n.headers.get("Cache-Control")||0[0],expires:n.headers.get("Expires")||0[0]}})}},e(v,"FetchSource"),P=v;function s(e,t){let n=e.getUint32(t+4,!0),s=e.getUint32(t+0,!0);return n*l(2,32)+s}e(s,"getUint64");function b(e,t){let n=new DataView(e),o=n.getUint8(7);if(o>3)throw new Error(`Archive is spec version ${o} but this library supports up to spec version 3`);return{specVersion:o,rootDirectoryOffset:s(n,8),rootDirectoryLength:s(n,16),jsonMetadataOffset:s(n,24),jsonMetadataLength:s(n,32),leafDirectoryOffset:s(n,40),leafDirectoryLength:s(n,48),tileDataOffset:s(n,56),tileDataLength:s(n,64),numAddressedTiles:s(n,72),numTileEntries:s(n,80),numTileContents:s(n,88),clustered:n.getUint8(96)===1,internalCompression:n.getUint8(97),tileCompression:n.getUint8(98),tileType:n.getUint8(99),minZoom:n.getUint8(100),maxZoom:n.getUint8(101),minLon:n.getInt32(102,!0)/1e7,minLat:n.getInt32(106,!0)/1e7,maxLon:n.getInt32(110,!0)/1e7,maxLat:n.getInt32(114,!0)/1e7,centerZoom:n.getUint8(118),centerLon:n.getInt32(119,!0)/1e7,centerLat:n.getInt32(123,!0)/1e7,etag:t}}e(b,"bytesToHeader");function H(e){let n={buf:new Uint8Array(e),pos:0},s=c(n),t=[],o=0;for(let e=0;e<s;e++){let i=c(n);t.push({tileId:o+i,offset:0,length:0,runLength:1}),o+=i}for(let e=0;e<s;e++)t[e].runLength=c(n);for(let e=0;e<s;e++)t[e].length=c(n);for(let e=0;e<s;e++){let o=c(n);o===0&&e>0?t[e].offset=t[e-1].offset+t[e-1].length:t[e].offset=o-1}return t}e(H,"deserializeIndex"),B=class ce extends Error{},e(B,"EtagMismatch"),m=B;function R(e,t){return n(this,null,function*(){let s=yield e.getBytes(0,16384);if(new DataView(s.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");let i=s.data.slice(0,me),n=b(i,s.etag),a=s.data.slice(n.rootDirectoryOffset,n.rootDirectoryOffset+n.rootDirectoryLength),r=`${e.getKey()}|${n.etag||""}|${n.rootDirectoryOffset}|${n.rootDirectoryLength}`,o=H(yield t(a,n.internalCompression));return[n,[r,o.length,o]]})}e(R,"getHeaderAndRoot");function N(e,t,s,o,i){return n(this,null,function*(){let a=yield e.getBytes(s,o,0[0],i.etag),r=yield t(a.data,i.internalCompression),n=H(r);if(n.length===0)throw new Error("Empty directory is invalid");return n})}return e(N,"getDirectory"),F=class ve{constructor(e=100,t=!0,n=g){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=n}getHeader(e){return n(this,null,function*(){let s=e.getKey(),n=this.cache.get(s);if(n)return n.lastUsed=this.counter++,n.data;let t=yield R(e,this.decompress);return t[1]&&this.cache.set(t[1][0],{lastUsed:this.counter++,data:t[1][2]}),this.cache.set(s,{lastUsed:this.counter++,data:t[0]}),this.prune(),t[0]})}getDirectory(e,t,s,o){return n(this,null,function*(){let i=`${e.getKey()}|${o.etag||""}|${t}|${s}`,n=this.cache.get(i);if(n)return n.lastUsed=this.counter++,n.data;let a=yield N(e,this.decompress,t,s,o);return this.cache.set(i,{lastUsed:this.counter++,data:a}),this.prune(),a})}prune(){if(this.cache.size>this.maxCacheEntries){let t=1/0,e;this.cache.forEach((n,s)=>{n.lastUsed<t&&(t=n.lastUsed,e=s)}),e&&this.cache.delete(e)}}invalidate(e){return n(this,null,function*(){this.cache.delete(e.getKey())})}},e(F,"ResolvedValueCache"),re=F,O=class ge{constructor(e=100,t=!0,n=g){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=n}getHeader(e){return n(this,null,function*(){let n=e.getKey(),t=this.cache.get(n);if(t)return t.lastUsed=this.counter++,yield t.data;let s=new Promise((t,n)=>{R(e,this.decompress).then(e=>{e[1]&&this.cache.set(e[1][0],{lastUsed:this.counter++,data:Promise.resolve(e[1][2])}),t(e[0]),this.prune()}).catch(e=>{n(e)})});return this.cache.set(n,{lastUsed:this.counter++,data:s}),s})}getDirectory(e,t,s,o){return n(this,null,function*(){let i=`${e.getKey()}|${o.etag||""}|${t}|${s}`,n=this.cache.get(i);if(n)return n.lastUsed=this.counter++,yield n.data;let a=new Promise((n,i)=>{N(e,this.decompress,t,s,o).then(e=>{n(e),this.prune()}).catch(e=>{i(e)})});return this.cache.set(i,{lastUsed:this.counter++,data:a}),a})}prune(){if(this.cache.size>=this.maxCacheEntries){let t=1/0,e;this.cache.forEach((n,s)=>{n.lastUsed<t&&(t=n.lastUsed,e=s)}),e&&this.cache.delete(e)}}invalidate(e){return n(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let n=new Promise((n,s)=>{this.getHeader(e).then(e=>{n(),this.invalidations.delete(t)}).catch(e=>{s(e)})});this.invalidations.set(t,n)})}},e(O,"SharedPromiseCache"),w=O,C=class pe{constructor(e,t,n){typeof e=="string"?this.source=new P(e):this.source=e,n?this.decompress=n:this.decompress=g,t?this.cache=t:this.cache=new w}getHeader(){return n(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,s,o){return n(this,null,function*(){let r=M(e,t,s),n=yield this.cache.getHeader(this.source);if(e<n.minZoom||e>n.maxZoom)return;let i=n.rootDirectoryOffset,a=n.rootDirectoryLength;for(let t=0;t<=3;t++){let s=yield this.cache.getDirectory(this.source,i,a,n),e=y(s,r);if(e){if(e.runLength>0){let t=yield this.source.getBytes(n.tileDataOffset+e.offset,e.length,o,n.etag);return{data:yield this.decompress(t.data,n.tileCompression),cacheControl:t.cacheControl,expires:t.expires}}i=n.leafDirectoryOffset+e.offset,a=e.length}else return}throw new Error("Maximum directory depth exceeded")})}getZxy(e,t,s,o){return n(this,null,function*(){try{return yield this.getZxyAttempt(e,t,s,o)}catch(n){if(n instanceof m)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,s,o);throw n}})}getMetadataAttempt(){return n(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,0[0],e.etag),n=yield this.decompress(t.data,e.internalCompression),s=new TextDecoder("utf-8");return JSON.parse(s.decode(n))})}getMetadata(){return n(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof m)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return n(this,null,function*(){let t=yield this.getHeader(),n=yield this.getMetadata(),s=_(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${s}`],vector_layers:n.vector_layers,attribution:n.attribution,description:n.description,name:n.name,version:n.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}},e(C,"PMTiles"),p=C,oe(A)})()